<script>
  // === CONFIG: working window (America/Chicago) ===
  const WORK_TZ   = "America/Chicago";
  const WORK_DAYS = [1,2,3,4,5]; // 1=Mon ... 5=Fri
  const START_HH  = 8;  // 08:00 local
  const END_HH    = 18; // 18:00 (6pm) local
  const REFRESH_MS = 20 * 60 * 1000; // 20 minutes (change as needed)

  let timer = null;

  // Use Page Visibility to avoid fetching in background tabs
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) stopScheduler();
    else startScheduler(true); // resume and fetch immediately
  });

  function inWorkWindow(date = new Date()) {
    // Convert to America/Chicago clock components
    const fmt = new Intl.DateTimeFormat('en-US', {
      timeZone: WORK_TZ, weekday: 'short', hour: '2-digit', hour12: false
    });
    // Extract weekday (Mon..Sun) and hour from formatted parts
    const parts = fmt.formatToParts(date);
    const wkStr = parts.find(p => p.type === 'weekday').value; // e.g., "Mon"
    const hrStr = parts.find(p => p.type === 'hour').value;    // "00".."23"

    const weekdayIdxMap = {Sun:0, Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6};
    const w = weekdayIdxMap[wkStr];
    const h = parseInt(hrStr, 10);

    const isWorkday = WORK_DAYS.includes(w);
    const inHours   = h >= START_HH && h < END_HH;
    return isWorkday && inHours;
  }

  async function safeFetchOnce() {
    if (!inWorkWindow()) {
      console.log("Skipping fetch: outside working hours.");
      updateStatus("Paused (outside working hours)");
      return;
    }
    updateStatus("Fetchingâ€¦");
    try {
      await fetchPrices(); // <-- call your existing function that fetches & updates UI
      updateStatus("");
    } catch (e) {
      updateStatus("Error: " + e.message);
      console.error(e);
    }
  }

  function startScheduler(immediate = false) {
    stopScheduler();
    if (document.hidden) return; // don't run in background
    timer = setInterval(safeFetchOnce, REFRESH_MS);
    if (immediate) safeFetchOnce();
  }

  function stopScheduler() {
    if (timer) clearInterval(timer);
    timer = null;
  }

  // OPTIONAL: show a little status text somewhere
  function updateStatus(text) {
    const el = document.getElementById("status");
    if (el) el.textContent = text;
  }

  // Kick off when the page loads
  window.addEventListener("load", () => startScheduler(true));
</script>
